### 1. Time Zone information system table

```
SELECT *
FROM sys.time_zone_info;
```
------------------------------------------------------------
### 2. Date and Timestamp Conversions

#### 2.1. Convert timestamp in UTC to PST
```
SELECT '2020-09-01 00:00:00' at time zone 'pst'
FROM	current_timezone;
```
__The current date and time__

__return only the timestamp portion__

#### 2.2. Extract time part
__Syntax__ | __Argument__ | __Explanation__
---------------| ------------ | ---------------
`DATE_PART()`  | 
```
SELECT	sales_month,
		DATEPART(day, sales_month) AS date,
		DATEPART(month, sales_month) AS month,
		DATEPART(year, sales_month) AS year
FROM	us_retail_sales;
```
```
SELECT	sales_month,
		DAY(sales_month) AS date,
		MONTH(sales_month) AS month,
		YEAR(sales_month) AS year
FROM	us_retail_sales;
```
__changing the format of dates and times__


------------------------------------------------------------
### 3. Time and Date Calculation


------------------------------------------------------------
### 4. Trending the Data

#### 4.1. Simple Trend
___Trend of a category based on the time unit___

The trend of the total 'retail and food services' sales in the US
```
SELECT	sales_month, sales
FROM	us_retail_sales
WHERE	kind_of_business = 'Retail and food services sales, total';
```

The monthly sales of the total 'retail and food services' sales in the US
```
SELECT	YEAR(sales_month) AS year,
		MONTH(sales_month)	AS month,
		SUM(sales) AS Revenue
FROM	us_retail_sales
GROUP BY	YEAR(sales_month), MONTH(sales_month)
ORDER BY	1, 2;
```

```
SELECT	FORMAT(sales_month, 'yyyy-MM') AS year_month,
		SUM(sales)	AS Revenue
FROM	us_retail_sales
GROUP BY FORMAT(sales_month, 'yyyy-MM')
ORDER BY 1;
```

#### 4.2. Category Comparison based on Time Series

The sales comparison between book stores, sport stores, and toy stores
```
SELECT	DATEPART(year, sales_month) AS year,
		kind_of_business,
		SUM(sales) AS Revenue
FROM	us_retail_sales
WHERE	kind_of_business IN	('Book stores',
				'Sporting goods stores',
				'Hobby, toy, and game stores')
GROUP BY DATEPART(year, sales_month), kind_of_business
ORDER BY 1 ASC;
```

* __CASE WHEN__

The comparison between genders clothing shopping trends
```
SELECT	YEAR(sales_month) AS year,
		kind_of_business,
		SUM(sales) AS Revenue
FROM	us_retail_sales
WHERE 	kind_of_business IN 	('Men''s clothing stores',
				'Women''s clothing stores')
GROUP BY YEAR(sales_month), kind_of_business
ORDER BY 1;
```

An In-depth comparison between genders clothing shopping trends by year (gap, ratio, percentage)
```
SELECT	year,
	SUM(men_sales) AS men_sales,
	SUM(women_sales) AS women_sales,
	SUM(women_sales) - SUM(men_sales) AS sales_gap,
	ROUND(SUM(women_sales)/ SUM(men_sales), 2) AS Ratio
FROM	(
		SELECT	YEAR(sales_month) AS year,
			CASE WHEN kind_of_business = 'Men''s clothing stores' THEN sales
			END AS men_sales,
			CASE WHEN kind_of_business = 'Women''s clothing stores' THEN sales
			END AS women_sales
		FROM	us_retail_sales
		WHERE kind_of_business IN	('Men''s clothing stores',
						'Women''s clothing stores')
		) a
GROUP BY year
ORDER BY 1;			
```

#### 4.3. Percent of Total Calculations
* __Self JOIN__
```
SELECT	sales_month, kind_of_business,
		ROUND((sales/total_sales)*100, 2) AS pct_total
FROM	(
		SELECT	a.sales_month, a.kind_of_business, a.sales,
			SUM(b.sales) AS total_sales
		FROM	us_retail_sales a
			INNER JOIN	us_retail_sales b ON a.sales_month = b.sales_month
			AND b.kind_of_business in ('Men''s clothing stores',
						'Women''s clothing stores')
			WHERE a.kind_of_business IN ('Men''s clothing stores',
						'Women''s clothing stores')
		GROUP BY	a.sales_month, a.kind_of_business, a.sales
	) self_join
--GROUP BY	sales_month, kind_of_business
ORDER BY	1, 2;
```
return the total sales of Men's each year and Women's each year
```
SELECT	YEAR(a.sales_month) AS yearly, a.kind_of_business, a.sales,
	SUM(b.sales) AS total_sales,
	a.sales*100/SUM(b.sales),
	ROUND(a.sales*100/SUM(b.sales), 2) AS pct_total
FROM	us_retail_sales a
	INNER JOIN	us_retail_sales b ON YEAR(a.sales_month) = YEAR(b.sales_month)
	AND a.kind_of_business = b.kind_of_business
	AND	b.kind_of_business IN ('Men''s clothing stores', 'Women''s clothing stores')
WHERE	a.kind_of_business IN ('Men''s clothing stores', 'Women''s clothing stores')
GROUP BY	YEAR(a.sales_month), a.kind_of_business, a.sales
ORDER BY	1, 2, 3;
```
* __Window Function__
```
SELECT	sales_month, kind_of_business, sales,
	SUM(sales)	OVER (PARTITION BY sales_month) AS total_sales,
	ROUND(sales*100/(SUM(sales)	OVER (PARTITION BY sales_month)), 2) AS pct_total
FROM	us_retail_sales
WHERE	kind_of_business IN ('Men''s clothing stores', 'women''s clothing stores');
```
return the total sales of Men's each year and Women's each year => group by year and kind of business
```
SELECT	YEAR(sales_month) AS yearly,
	kind_of_business, sales,
	SUM(sales) OVER (PARTITION BY YEAR(sales_month),
			kind_of_business) AS total_sales,
	ROUND(sales*100/SUM(sales) OVER (PARTITION BY YEAR(sales_month),
							kind_of_business), 2)	AS pct_total
FROM	us_retail_sales
WHERE	kind_of_business IN ('Men''s clothing stores', 'Women''s clothing stores');
```
------------------------------------------------------------
### 5. Indexing to see Percent change over time

* __Window Function__ => `FIRST_VALUE()` // `LAST_VALUE()`

the percent changes in sales of Women's by years
```
SELECT	yearly,
	FIRST_VALUE(sales) OVER (ORDER BY yearly) AS index_sales,
	sales
	ROUND(((sales/ FIRST_VALUE(sales) OVER (ORDER BY yearly) - 1) *100, 2) AS pct_change
FROM	(
		SELECT	DATEPART(year, sales_month) AS yearly,
			SUM(sales) AS sales
		FROM	us_retail_sales
		WHERE	kind_of_business = 'Women''s clothing stores'
		GROUP BY	DATEPART(year, sales_month)
	) a;
```
the percent changes in sales of Women's and Men's by years
```
SELECT	yearly,
		kind_of_business,
		FIRST_VALUE(sales) OVER (PARTITION BY kind_of_business ORDER BY yearly) AS index_sales,
		sales,
		ROUND((sales/ FIRST_VALUE(sales) OVER (PARTITION BY kind_of_business ORDER BY yearly) - 1) *100, 2) AS pct_change
FROM	(
		SELECT	DATEPART(year, sales_month) AS yearly,
				kind_of_business,
				SUM(sales) AS sales
		FROM	us_retail_sales
		WHERE	kind_of_business IN ('Women''s clothing stores', 'Men''s clothing stores')
		GROUP BY	DATEPART(year, sales_month), kind_of_business
		) a;
```

* __Self JOIN__ ...

___Note: Telling the database to return an alternate default value when it encounters a zero___

------------------------------------------------------------
### 6. Rolling Time Windows
#### 6.1. Rolling Aggregation 
* __Self JOIN__
```
SELECT	a.sales_month, a.kind_of_business, a.sales,
	b.sales_month AS rolling_sales_month,
	b.sales AS rolling_sales
FROM	us_retail_sales a
	INNER JOIN	us_retail_sales b ON a.kind_of_business = b.kind_of_business
	AND b.sales_month BETWEEN DATEADD(MONTH, -11, a.sales_month) AND a.sales_month
	AND b.kind_of_business = 'Women''s clothing stores'
WHERE	a.kind_of_business = 'Women''s clothing stores'
	AND a.sales_month = '2019-12-01'
```
applying the aggregation (average) into the query
```
SELECT	a.sales_month, a.kind_of_business, a.sales,
	AVG(b.sales) AS moving_avg, 
	COUNT(b.sales) AS record_count
FROM	us_retail_sales a
	INNER JOIN	us_retail_sales b ON a.kind_of_business = b.kind_of_business
	AND b.sales_month BETWEEN DATEADD(MONTH, -11, a.sales_month) AND a.sales_month
	AND b.kind_of_business = 'Women''s clothing stores'
	WHERE	a.kind_of_business = 'Women''s clothing stores'
	AND a.sales_month >= '1993-01-01'
GROUP BY	a.sales_month, a.kind_of_business, a.sales
ORDER BY	1;
```
* __Window Function__ => `RANGE` // `ROWS` // `GROUPS`
```
SELECT	sales_month,
	AVG(sales) OVER	(ORDER BY sales_month
			ROWS BETWEEN 11 preceding AND CURRENT ROW) AS rolling_avg,
	COUNT(sales) OVER (ORDER BY sales_month
			ROWS BETWEEN 11 preceding AND CURRENT ROW) AS record_count
FROM	us_retail_sales
WHERE	kind_of_business = 'Women''s clothing stores';
```

#### 6.2. Rolling Aggregation with Sparse Data

* __date dimension__

retrieve a date dimension table with filters
```
SELECT  date, first_day_of_month
FROM 	date_dim
WHERE	date = first_day_of_month
	AND date BETWEEN '1993-01-01' AND '2020-12-01';
```

return the sales of women's clothing stores in every JULY and JANUARY month
```
SELECT	sales_month, kind_of_business, sales
FROM	us_retail_sales
WHERE	kind_of_business = 'Women''s clothing stores'
	AND	DATEPART(MONTH, sales_month) IN (1, 7)
```
JOIN 2 above tables together
```
SELECT	dim.date, wo.sales_month, wo.sales
FROM	date_dim dim 
	INNER JOIN	
		(SELECT	sales_month, kind_of_business, sales
		 FROM	us_retail_sales
		 WHERE	kind_of_business = 'Women''s clothing stores'
			AND	DATEPART(MONTH, sales_month) IN (1, 7)		-- filter only the JAN and JUL
		) wo ON (wo.sales_month BETWEEN DATEADD(MONTH, -11, dim.date) AND dim.date)
WHERE	dim.date = dim.first_day_of_month
	AND dim.date BETWEEN '1993-01-01' AND '2020-12-01'
ORDER BY dim.date, wo.sales_month;
```
Perform calculations on the table
```
SELECT	dim.date,
	AVG(sales) AS moving_avg,
	COUNT(sales) AS records
FROM	date_dim dim 
	INNER JOIN	
		(SELECT	sales_month, kind_of_business, sales
		 FROM	us_retail_sales
		 WHERE	kind_of_business = 'Women''s clothing stores'
			AND	DATEPART(MONTH, sales_month) IN (1, 7)			-- filter only the JAN and JUL
		) wo ON wo.sales_month BETWEEN DATEADD(MONTH, -11, dim.date) AND dim.date
WHERE	dim.date = dim.first_day_of_month
	AND dim.date BETWEEN '1993-01-01' AND '2020-12-01'
GROUP BY	dim.date
ORDER BY	dim.date;
```
___Note: As a result, this query returns one row per month; the constant sale value until a new data point (January and July) is added.___

In case of returning the current month's sales value when using date dimension table, `CASE WHEN` can be used.
```
SELECT	dim.date,
	AVG(sales) AS moving_avg,
	COUNT(sales) AS records,
	MAX	(CASE	WHEN dim.date = wo.sales_month THEN wo.sales 
			ELSE 0
		END) AS sales_in_month
FROM	date_dim dim 
	INNER JOIN	
	(SELECT	sales_month, kind_of_business, sales
	 FROM	us_retail_sales
	 WHERE	kind_of_business = 'Women''s clothing stores'
		AND	DATEPART(MONTH, sales_month) IN (1, 7)			-- filter only the JAN and JUL
	) wo ON wo.sales_month BETWEEN DATEADD(MONTH, -11, dim.date) AND dim.date
WHERE	dim.date = dim.first_day_of_month
	AND dim.date BETWEEN '1993-01-01' AND '2020-12-01'
GROUP BY	dim.date 
ORDER BY	dim.date;
```

* __Self JOIN__ => when date dimension table is not available in the database```
```
SELECT	a.sales_month,
		AVG(b.sales) AS moving_avg
FROM	(
		SELECT	DISTINCT sales_month
		FROM	us_retail_sales
		WHERE	sales_month BETWEEN '1993-01-01' AND '2020-12-01'
		) a INNER JOIN
		us_retail_sales b ON	b.sales_month BETWEEN DATEADD(MONTH, -11, a.sales_month) AND a.sales_month
								AND b.kind_of_business = 'Women''s clothing stores'
GROUP BY	a.sales_month
ORDER BY	1;
```




##### 6.3. Cumulative Values

------------------------------------------------------------
### 7. Anlyzing with Seasonality


------------------------------------------------------------
### 8. Period Comparison

#### 8.1. Period-over-Period Comparisons: YoY and MoM

#### 8.2. Period-over-Period Comparisons: Same Month versus Last Year

#### 8.3. Multiple Prior Periods

